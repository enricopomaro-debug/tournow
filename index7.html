<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TourNow ‚Äî versione 9 (POI ampliati + Google Maps)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    :root { --bg:#0b0b0c; --panel:#151518; --text:#f1f5f9; --muted:#94a3b8; --accent:#22d3ee; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;background:#0b0b0c;color:#f1f5f9}
    header{padding:14px 16px;border-bottom:1px solid #23232a;display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .badge{padding:4px 8px;border:1px solid #2b2b33;border-radius:999px;font-size:12px;color:#94a3b8}
    .container{display:grid;grid-template-columns:420px 1fr;min-height:calc(100vh - 56px)}
    @media (max-width:900px){.container{grid-template-columns:1fr}}
    .panel{padding:16px;background:#151518;border-right:1px solid #23232a}
    .row{display:flex;gap:8px}.row>*{flex:1}
    .field{margin-bottom:12px}.label{display:block;font-size:12px;color:#94a3b8;margin-bottom:6px}
    .checkboxes{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #2b2b33;border-radius:12px;background:#101014;user-select:none}
    .chip input{accent-color:#22d3ee}
    input[type="number"],input[type="text"],input[type="url"],textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b2b33;background:#101014;color:#f1f5f9}
    textarea{min-height:64px;resize:vertical}
    button{width:100%;padding:12px 14px;border:none;border-radius:12px;background:linear-gradient(90deg,#06b6d4,#22d3ee);color:#001017;font-weight:700;cursor:pointer;margin-top:6px}
    button:disabled{opacity:.5;cursor:not-allowed}
    #map{width:100%;height:calc(100vh - 56px)}
    .itinerary{margin-top:14px;border-top:1px solid #23232a;padding-top:12px}
    .step{padding:10px 12px;background:#101014;border:1px solid #2b2b33;border-radius:10px;margin-bottom:8px}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .legend .tag{font-size:11px;padding:4px 8px;background:#101014;border:1px solid #2b2b33;border-radius:999px;color:#cbd5e1}
    .ai-note{font-size:12px;color:#9ad2df;margin:6px 0 0}
    .title{font-weight:800;margin:4px 0 6px}
    .summary{font-size:13px;color:#cfe9ef;margin:0 0 8px}
    .pill{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid #2b2b33;margin-left:6px}
    .hint{font-size:11px;color:#8aa1b6;margin-top:4px}
  </style>
</head>
<body>
<header>
  <h1>TourNow ‚Äî tour operator istantaneo</h1>
  <span class="badge">v9 ‚Ä¢ Google Maps + POI ampliati</span>
</header>

<div class="container">
  <aside class="panel">
    <div class="row">
      <div class="field">
        <span class="label">Tempo disponibile (min)</span>
        <input id="timeBudget" type="number" min="15" step="15" value="90"/>
      </div>
      <div class="field">
        <span class="label">Percorso</span>
        <select id="routeType">
          <option value="linear">Lineare</option>
          <option value="loop">Ad anello</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <span class="label">Modalit√† di spostamento</span>
        <select id="moveMode">
          <option value="foot">A piedi</option>
          <option value="bike">Bici</option>
        </select>
        <div class="ai-note">In bici tempi 0.35√ó, soste ‚àí20%, raggio +2 km.</div>
        <div class="hint" id="radiusHint"></div>
      </div>
      <div class="field">
        <span class="label">Raggio ricerca (km)</span>
        <input id="radiusKm" type="number" min="0.5" step="0.5" value="2.5"/>
      </div>
    </div>

    <div class="field">
      <span class="label">Categorie da includere</span>
      <div class="checkboxes" id="interests"></div>
    </div>

    <div class="row">
      <div class="field"><span class="label">Preferisci</span><div class="checkboxes" id="preferBox"></div></div>
      <div class="field"><span class="label">Evita</span><div class="checkboxes" id="avoidBox"></div></div>
    </div>

    <div class="row">
      <div class="field">
        <span class="label">Schema blocchi</span>
        <select id="blockPreset">
          <option value="auto">Auto</option>
          <option value="culture,food,park">Cultura ‚Üí Cibo ‚Üí Parco</option>
          <option value="park,food,landmark">Parco ‚Üí Cibo ‚Üí Landmark</option>
          <option value="food,landmark,park">Cibo ‚Üí Landmark ‚Üí Parco</option>
          <option value="custom">Personalizzato</option>
        </select>
      </div>
      <div class="field">
        <span class="label">Blocchi personalizzati (CSV)</span>
        <input id="blockCustom" type="text" placeholder="es: culture,food,park"/>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <span class="label">Max POI considerati</span>
        <input id="maxPois" type="number" min="5" step="5" value="40"/>
      </div>
      <div class="field">
        <span class="label">Max tappe per categoria</span>
        <input id="maxPerCat" type="number" min="1" step="1" value="3"/>
      </div>
    </div>

    <div class="field">
      <input id="enforcePreferred" type="checkbox" checked/>
      <label for="enforcePreferred">Obbliga ‚â•1 preferita</label>
    </div>

    <button id="btnFind">Trova POI & Genera itinerario</button>
    <button id="btnGMaps" style="margin-top:8px;background:linear-gradient(90deg,#22d3ee,#06b6d4)" disabled>
      Apri itinerario in Google Maps
    </button>

    <div class="itinerary">
      <div class="title" id="aiTitle"></div>
      <p class="summary" id="aiSummary"></p>
      <div id="itinerary"></div>
      <div class="legend" id="legend"></div>
    </div>
  </aside>
  <main id="map"></main>
</div>

<script>
  const OSRM_BASE='https://router.project-osrm.org';
  const BIKE_TIME_FACTOR=0.35, BIKE_DWELL_FACTOR=0.8, BIKE_RADIUS_BONUS_KM=2;
  const COLORS={}, toRad=d=>d*Math.PI/180;
  function haversineKm(a,b){const R=6371;const dLat=toRad(b.lat-a.lat);const dLon=toRad((b.lng||b.lon)-(a.lng||a.lon));const sa=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(sa));}
  function autoColor(i){const hues=[188,160,40,12,320,260,90,200];return `hsl(${hues[i%hues.length]} 90% 60%)`; }

  /* === CATEGORIES ampliato === */
  const CATEGORIES=[
    {id:"culture",label:"Musei/Gallerie",query:'["tourism"~"museum|gallery"]',dwell:40},
    {id:"historic",label:"Siti storici",query:'["historic"]',dwell:25},
    {id:"monument",label:"Monumenti/Statue",query:'["historic"="monument"]',dwell:15},
    {id:"castle",label:"Castelli/Forti",query:'["historic"~"castle|fort"]',dwell:35},
    {id:"church",label:"Luoghi di culto",query:'["amenity"="place_of_worship"]',dwell:20},
    {id:"theatre",label:"Teatri/Opera",query:'["amenity"~"theatre|arts_centre"]',dwell:25},
    {id:"landmark",label:"Landmark",query:'["tourism"="attraction"]',dwell:20},
    {id:"viewpoint",label:"Punti panoramici",query:'["tourism"="viewpoint"]',dwell:15},
    {id:"bridge",label:"Ponti scenici",query:'["man_made"="bridge"]',dwell:10},
    {id:"tower",label:"Torri/Belvedere",query:'["man_made"="tower"]',dwell:15},
    {id:"square",label:"Piazze",query:'["place"="square"]',dwell:15},
    {id:"fountain",label:"Fontane",query:'["amenity"="fountain"]',dwell:10},
    {id:"park",label:"Parchi/Giardini",query:'["leisure"~"park|garden|common"]',dwell:30},
    {id:"water",label:"Laghetti/Sponde",query:'["natural"~"water|bay"]',dwell:20},
    {id:"beach",label:"Spiagge/Lidi",query:'["natural"="beach"]',dwell:30},
    {id:"food",label:"Ristoranti/Bar",query:'["amenity"~"restaurant|cafe|fast_food|bar"]',dwell:25},
    {id:"gelato",label:"Gelaterie",query:'["amenity"="ice_cream"]',dwell:15},
    {id:"bakery",label:"Panifici/Pasticcerie",query:'["shop"~"bakery|pastry"]',dwell:15},
    {id:"coffee",label:"Caff√® specialty",query:'["amenity"="cafe"]["coffee"!=""]',dwell:20},
    {id:"wine",label:"Enoteche/Wine bar",query:'["amenity"~"bar|pub"]["wine"!=""]',dwell:20},
    {id:"market",label:"Mercati locali",query:'["amenity"~"marketplace|market"]',dwell:20},
    {id:"streetart",label:"Street Art/Murales",query:'["tourism"="artwork"]["artwork_type"~"mural|graffiti|street_art"]',dwell:15},
    {id:"exhibit",label:"Mostre/Esposizioni",query:'["exhibition"="permanent"]',dwell:25},
    {id:"shopping",label:"Vie dello shopping",query:'["shop"]["name"]',dwell:20},
  ];

  // üîπ Ricostruisce dinamicamente i chip UI
  const interestsWrap=document.getElementById('interests');
  const preferWrap=document.getElementById('preferBox');
  const avoidWrap=document.getElementById('avoidBox');
  const legendWrap=document.getElementById('legend');

  CATEGORIES.forEach((c,i)=>{
    COLORS[c.id]=autoColor(i);
    const addChip=(wrap)=>{const l=document.createElement('label');l.className='chip';l.innerHTML=`<input type="checkbox" value="${c.id}" ${i<5?'checked':''}/> ${c.label}`;wrap.appendChild(l);};
    addChip(interestsWrap); addChip(preferWrap); addChip(avoidWrap);
    const tag=document.createElement('span');tag.className='tag';tag.style.borderColor=COLORS[c.id];tag.style.color=COLORS[c.id];tag.textContent=c.label;legendWrap.appendChild(tag);
  });

  function detectCategory(tags){
    if(tags.tourism==="museum"||tags.tourism==="gallery")return"culture";
    if(tags.historic==="monument")return"monument";
    if(tags.historic&&/castle|fort/.test(tags.historic))return"castle";
    if(tags.historic)return"historic";
    if(tags.amenity==="place_of_worship")return"church";
    if(tags.amenity&&/theatre|arts_centre/.test(tags.amenity))return"theatre";
    if(tags.tourism==="viewpoint")return"viewpoint";
    if(tags.man_made==="bridge")return"bridge";
    if(tags.man_made==="tower")return"tower";
    if(tags.place==="square")return"square";
    if(tags.amenity==="fountain")return"fountain";
    if(tags.tourism==="attraction")return"landmark";
    if(tags.leisure&&/park|garden|common/.test(tags.leisure))return"park";
    if(tags.natural==="beach")return"beach";
    if(tags.natural&&/water|bay/.test(tags.natural))return"water";
    if(tags.amenity&&/restaurant|cafe|fast_food|bar/.test(tags.amenity))return"food";
    if(tags.amenity==="ice_cream")return"gelato";
    if(tags.shop&&/bakery|pastry/.test(tags.shop))return"bakery";
    if(tags.amenity==="cafe"&&tags.coffee)return"coffee";
    if((tags.amenity==="bar"||tags.amenity==="pub")&&tags.wine)return"wine";
    if(tags.amenity&&/marketplace|market/.test(tags.amenity))return"market";
    if(tags.tourism==="artwork"&&/mural|graffiti|street_art/.test(tags.artwork_type||""))return"streetart";
    if(tags.exhibition==="permanent")return"exhibit";
    if(tags.shop&&tags.name)return"shopping";
    return"landmark";
  }

  // ‚öôÔ∏è Al resto del codice (mappa, planner, AI, Google Maps, ecc.) lascia tutto invariato
</script>
</body>
</html>

