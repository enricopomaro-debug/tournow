<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TourNow • v11 (Ottimizzata)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--text:#e8eaf2;--muted:#aab0c0;
      --border:#242938;--accent:#93c5fd;--accent2:#6ee7b7;--danger:#fda4af;
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(23,26,33,.95),rgba(23,26,33,.7));backdrop-filter:blur(6px)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .toolbar{display:grid;gap:12px;grid-template-columns:1fr 1fr auto;align-items:end}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    label{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:var(--muted)}
    select,input,button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--text)}
    button{cursor:pointer}
    button.primary{background:linear-gradient(90deg,#2563eb,#10b981);border:none}
    button:disabled{opacity:.6;cursor:not-allowed}
    #map{height:calc(100vh - 140px)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .banner{display:none;margin-top:10px;border:1px solid var(--border);border-left:4px solid var(--danger);background:#1b0f12;color:#ffd7db;border-radius:10px;padding:10px}
    .ok{border-left-color:var(--accent2);background:#0f1b14;color:#caf0d5}
    @media (max-width:900px){.toolbar{grid-template-columns:1fr}#map{height:65vh}}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="toolbar card">
        <div>
          <label for="duration">Durata</label>
          <select id="duration">
            <option value="60">1 ora</option>
            <option value="120">2 ore</option>
            <option value="180">3 ore</option>
          </select>
        </div>
        <div>
          <label for="category">Categoria</label>
          <select id="category">
            <option value="all">Tutte</option>
            <option value="food">Cibo & Caffè</option>
            <option value="monuments">Monumenti</option>
            <option value="parks">Parchi</option>
          </select>
        </div>
        <div style="justify-self:end">
          <button class="primary" id="btnGenerate">Genera itinerario</button>
        </div>
      </div>
      <div id="status" class="banner"></div>
    </div>
  </header>

  <main class="container" style="margin-top:10px">
    <div id="map" class="card"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // =========================
    // MINI UTILS
    // =========================
    const $ = (id)=>document.getElementById(id);
    function showBanner(msg, ok=false){
      const box = $("status");
      box.textContent = msg;
      box.className = "banner" + (ok ? " ok": "");
      box.style.display = "block";
      clearTimeout(showBanner._t);
      showBanner._t = setTimeout(()=>{ box.style.display="none"; }, 4500);
    }
    function lsGet(key, fallback){ try{ const v=localStorage.getItem(key); return v ?? fallback; }catch{ return fallback } }
    function lsSet(key, value){ try{ localStorage.setItem(key, value) }catch{} }

    // =========================
    // STATE
    // =========================
    const state = {
      map: null,
      markers: L.layerGroup(),
      userMarker: null
    };

    // =========================
    // MAP INIT
    // =========================
    const map = L.map('map');
    state.map = map;
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }).addTo(map);
    state.markers.addTo(map);
    map.setView([45.07, 11.79], 12); // Rovigo/Lusia approx

    function setUserMarker(lat, lng, label='La mia posizione'){
      if(state.userMarker) state.map.removeLayer(state.userMarker);
      state.userMarker = L.marker([lat, lng]).addTo(state.map).bindPopup(label).openPopup();
    }

    // =========================
    // DYNAMIC CONTROLS (persist)
    // =========================
    $("duration").value = lsGet("tw_duration", "120");
    $("category").value = lsGet("tw_category", "all");
    $("duration").addEventListener("change", e=>lsSet("tw_duration", e.target.value));
    $("category").addEventListener("change", e=>lsSet("tw_category", e.target.value));

    // =========================
    // SAMPLE POIs (placeholder)
    // =========================
    const POIS = [
      {id:1, name:"Caffè Centrale", lat:45.072, lng:11.788, type:"food"},
      {id:2, name:"Duomo storico", lat:45.068, lng:11.786, type:"monuments"},
      {id:3, name:"Parco cittadino", lat:45.075, lng:11.793, type:"parks"}
    ];
    function filterPOIs(cat){ return cat==="all" ? POIS : POIS.filter(p=>p.type===cat); }

    function drawPOIs(pois){
      state.markers.clearLayers();
      const group = L.featureGroup();
      pois.forEach(p=>{
        const m = L.circleMarker([p.lat, p.lng], {radius:6});
        m.bindPopup(p.name);
        state.markers.addLayer(m);
        group.addLayer(L.marker([p.lat, p.lng])); // for bounds calc
      });
      if(pois.length){
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    // =========================
    // GEOLOCATION
    // =========================
    async function getUserLocation(){
      try{
        const pos = await new Promise((resolve, reject)=>{
          if(!navigator.geolocation) return reject(new Error("Geolocalizzazione non supportata"));
          navigator.geolocation.getCurrentPosition(
            p=>resolve({lat:p.coords.latitude, lng:p.coords.longitude}),
            err=>reject(err),
            {enableHighAccuracy:true, timeout:8000, maximumAge:30000}
          );
        });
        return pos;
      }catch(err){
        throw new Error("Posizione non disponibile. Consenti i permessi del browser.");
      }
    }

    // =========================
    // ITINERARY (stub invariato)
    // =========================
    async function generate(){
      const btn = $("btnGenerate");
      btn.disabled = true; const prev = btn.textContent; btn.textContent = "Calcolo…";
      try{
        const start = await getUserLocation();
        setUserMarker(start.lat, start.lng);
        map.setView([start.lat, start.lng], 14);

        const cat = $("category").value;
        const list = filterPOIs(cat);
        drawPOIs(list);

        showBanner("Itinerario generato dalla tua posizione", true);
        // TODO: qui resta la tua logica v11 per tempi/percorso usando 'start'
      }catch(err){
        showBanner(err.message, false);
      }finally{
        btn.disabled = false; btn.textContent = prev;
      }
    }

    $("btnGenerate").addEventListener("click", generate);

    // Soft preflight (niente alert)
    (async function preflight(){
      try{
        const pos = await getUserLocation();
        setUserMarker(pos.lat, pos.lng);
        map.setView([pos.lat, pos.lng], 14);
        showBanner("Posizione rilevata", true);
      }catch(_){ /* silenzioso */ }
    })();
  </script>
</body>
</html>
